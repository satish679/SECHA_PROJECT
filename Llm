import json

def generate_rotation_plan(finding):
    prompt = f"""
    you are a security remediation expert.
    Return ONLY valid JSON.

    Create a rotation plan for the leaked secret below.

    Finding:
    {finding}

    Required JSON schema:
    {{
        "action": "rotate | revoke | relocate",
        "recommended_storage": "vault|aws_secrets_manager|gcp_secret_manager",
        "rotation_window": "7d/14d/30d",
        "notes": "short explanation"
    }}
    """

    response = ollama.generate(model="llama2:7b", prompt=prompt)
    text = response.get('response', '').strip()
    
    if not text:
        raise ValueError("LLM returned empty response")

    # Remove any markdown/code fences
    for marker in ["```json", "```"]:
        text = text.replace(marker, "")
    
    # Try to extract JSON by finding the first '{' and last '}'
    start = text.find("{")
    end = text.rfind("}")
    if start == -1 or end == -1:
        raise ValueError(f"No JSON object found in LLM response: {text}")

    json_text = text[start:end+1]

    try:
        return json.loads(json_text)
    except json.JSONDecodeError as e:
        raise ValueError(f"Failed to parse JSON: {json_text}\nOriginal error: {e}")
